# Каталог товаров — Архитектура по Best Practices

Документ описывает **идеальную** реализацию каталога, основываясь на анализе референса и устраняя все обнаруженные ограничения. Стек: Laravel + Inertia + React.

---

## Компоновка элементов каталога

### Desktop — Grid View (≥1024px)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Главная  ›  Категория  ›  Подкатегория                     [Breadcrumbs]  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Подкатегория ¹²³ᵗᵒᵛ                    [Фильтры] [Вид] [Показ.] [Сорт.]  │
│  Описание категории / бренда / коллекции                                    │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  [Сбросить всё] [★ Сохранить] [Бренд: Lelo ×] [Цвет: Черный ×]            │
│  [★ Мой фильтр ×] [★ Новинки Lelo ×]                 [SelectedFilters bar] │
├──────────────┬──────────────────────────────────────────────────────────────┤
│              │                                                              │
│  ФИЛЬТРЫ     │   ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐         │
│  (sidebar)   │   │      │  │      │  │      │  │      │  │      │         │
│  w=224px     │   │ Card │  │ Card │  │ Card │  │ Card │  │ Card │         │
│              │   │  1   │  │  2   │  │  3   │  │  4   │  │  5   │         │
│ ┌──────────┐ │   │      │  │      │  │      │  │      │  │      │         │
│ │🔍 Поиск  │ │   └──────┘  └──────┘  └──────┘  └──────┘  └──────┘         │
│ └──────────┘ │                                                              │
│              │   ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐         │
│ ▼ Коллекции  │   │      │  │      │  │      │  │      │  │      │         │
│   ☐ Новинки  │   │ Card │  │ Card │  │ Card │  │ Card │  │ Card │         │
│   ☐ Хиты     │   │  6   │  │  7   │  │  8   │  │  9   │  │  10  │         │
│              │   │      │  │      │  │      │  │      │  │      │         │
│ ▼ Категории  │   └──────┘  └──────┘  └──────┘  └──────┘  └──────┘         │
│   ☐ Одежда   │                                                              │
│   ☐ Бельё    │   ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐         │
│              │   │      │  │      │  │      │  │      │  │      │         │
│ ▼ Бренды     │   │ Card │  │ Card │  │ Card │  │ Card │  │ Card │         │
│   ☐ Lelo (5) │   │  11  │  │  12  │  │  13  │  │  14  │  │  15  │         │
│   ☐ Fun (3)  │   │      │  │      │  │      │  │      │  │      │         │
│              │   └──────┘  └──────┘  └──────┘  └──────┘  └──────┘         │
│ ▼ Цена       │                                                              │
│  [min]-[max] │   ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐         │
│  [0-1000  3] │   │ Card │  │ Card │  │ Card │  │ Card │  │ Card │         │
│  [1000+   2] │   │  16  │  │  17  │  │  18  │  │  19  │  │  20  │         │
│              │   └──────┘  └──────┘  └──────┘  └──────┘  └──────┘         │
│ ▼ Наличие    │                                                              │
│  ☐ В наличии │──────────────────────────────────────────────────────────────│
│  ☐ Предзаказ │                                                              │
│              │        Показано 1–20 из 48 товаров                           │
│ ▼ Размер     │        ☐ Включить бесконечную прокрутку                      │
│  ☐ S (4)     │        ‹ 1  2  [3]  ...  5 ›                                │
│  ☐ M (6)     │                                                              │
│  ☐ L (2)     │                                                              │
│              │                                                              │
└──────────────┴──────────────────────────────────────────────────────────────┘
```

### Desktop — List View

```
┌──────────────┬──────────────────────────────────────────────────────────────┐
│              │                                                              │
│  ФИЛЬТРЫ     │  ┌────────────────────────────────────────────────────────┐  │
│  (sidebar)   │  │ [img]  Название товара 1                              │  │
│              │  │        Бренд · Категория · ★ 4.5                      │  │
│  (аналогично │  │        Краткое описание товара...                      │  │
│   grid view) │  │        ██ В наличии         ₽1 200  [В корзину] [♡]   │  │
│              │  └────────────────────────────────────────────────────────┘  │
│              │                                                              │
│              │  ┌────────────────────────────────────────────────────────┐  │
│              │  │ [img]  Название товара 2                              │  │
│              │  │        Бренд · Категория · ★ 4.2                      │  │
│              │  │        Краткое описание товара...                      │  │
│              │  │        ██ Предзаказ    ₽̶2̶0̶0̶0̶  ₽1 700  [В корзину]   │  │
│              │  └────────────────────────────────────────────────────────┘  │
│              │                                                              │
│              │  ┌────────────────────────────────────────────────────────┐  │
│              │  │ [img]  Название товара 3                              │  │
│              │  │        ...                                            │  │
│              │  └────────────────────────────────────────────────────────┘  │
│              │                                                              │
└──────────────┴──────────────────────────────────────────────────────────────┘
```

### Mobile (<1024px)

```
┌──────────────────────────────┐
│ Главная › Категория          │
├──────────────────────────────┤
│                              │
│ Подкатегория ¹²³ᵗᵒᵛ          │
│ Описание...                  │
│                              │
│ [Фильтры] [Вид] [Пок.] [Сор]│ ← горизонтальный скролл
├──────────────────────────────┤
│ [Сбросить] [Бренд:Lelo ×]   │
│ [★ Мой фильтр ×]            │
├──────────────────────────────┤
│                              │
│  ┌────────┐  ┌────────┐     │
│  │        │  │        │     │
│  │ Card 1 │  │ Card 2 │     │  grid-cols-2
│  │        │  │        │     │
│  └────────┘  └────────┘     │
│                              │
│  ┌────────┐  ┌────────┐     │
│  │        │  │        │     │
│  │ Card 3 │  │ Card 4 │     │
│  │        │  │        │     │
│  └────────┘  └────────┘     │
│                              │
│    Показано 1–20 из 48       │
│    ☐ Бесконечная прокрутка   │
│    ‹ 1  [2]  3  ...  5 ›    │
│                              │
└──────────────────────────────┘

         Нажатие на [Фильтры]:

┌──────────────────────────────┐
│ ┌──────────────────────────┐ │
│ │   Фильтры            [×] │ │
│ │                          │ │
│ │  🔍 Поиск...             │ │  ← Sheet (drawer)
│ │                          │ │     выдвигается справа
│ │  ▼ Коллекции             │ │
│ │    ☐ Новинки             │ │
│ │    ☐ Хиты                │ │
│ │                          │ │
│ │  ▼ Категории             │ │
│ │    ☐ Одежда              │ │
│ │    ☐ Бельё               │ │
│ │                          │ │
│ │  ▼ Бренды                │ │
│ │    ☐ Lelo (5)            │ │
│ │    ☐ Fun Factory (3)     │ │
│ │                          │ │
│ │  ▼ Цена                  │ │
│ │    [min] - [max]         │ │
│ │                          │ │
│ │  ▼ Наличие               │ │
│ │    ☐ В наличии           │ │
│ │    ☐ Предзаказ           │ │
│ │                          │ │
│ │  ▼ Размер                │ │
│ │    ☐ S (4)               │ │
│ │    ☐ M (6)  ☐ L (2)     │ │
│ └──────────────────────────┘ │
└──────────────────────────────┘
```

### Карточка товара (ProductGridItem)

```
┌────────────────────┐
│ ┌────────────────┐ │
│ │                │ │
│ │   [Фото]       │ │
│ │                │ │
│ │  -15%   [♡]    │ │  ← Badge скидки + кнопка избранного
│ └────────────────┘ │
│                    │
│  Название товара   │
│  Бренд             │
│                    │
│  ██ В наличии      │  ← Статус: зелёный / жёлтый / серый
│                    │
│  ₽̶2̶ ̶0̶0̶0̶   ₽1 700  │  ← Старая цена зачёркнута + новая красным
│                    │
│  [-] 1 [+]         │  ← Контрол количества
│  [  В корзину  ]   │
└────────────────────┘
```

---

## 1. Заголовок и мета-информация

1. **Динамический заголовок** по приоритету: Избранное → Коллекция → Категория → Бренд → Поиск → Акция → «Каталог товаров». Формируется **на сервере** в контроллере и передаётся как prop.

2. **Счётчик товаров** — `meta.total` после применения фильтров. Отображается в `<sup>` рядом с заголовком: «123 товара».

3. **Описание** — если активна сущность (коллекция/категория/бренд) — выводится её `description`. Иначе — контекстный подзаголовок.

4. **Хлебные крошки** — строятся по `ancestors_and_self` категории. Для бренда/коллекции — свой вид крошек (`Главная → Бренды → {name}`). Для распродажи — спецкрошка.

---

## 2. Контексты просмотра

5. **Единый компонент** — все контексты (`/products`, `/brands/{slug}`, `/collections/{slug}`, `/products/promotion/{slug}`, `/products/favorites`) рендерят один и тот же `Products/Index.jsx`. Различия — в серверных props (`initialBrand`, `initialCategory`, `initialCollection`, `initialPromotion`).

6. **Контроллер** — отдельные методы `index()`, `byBrand()`, `byCategory()`, `byCollection()`, `byPromotion()`. Каждый рендерит Inertia-страницу `Products/Index` с соответствующей начальной сущностью.

7. **URL-стратегия** — `replaceState()` без перезагрузки. Базовый путь зависит от контекста: `/brands/{slug}?...`, `/collections/{slug}?...` и т.д.

8. **Категории — иерархические** (дерево). `include_descendants=1` по умолчанию — товары из вложенных категорий включаются.

9. **`category_id` vs `category_ids[]`** — `category_id` (single) задаётся маршрутом, `category_ids[]` (multi) — панелью фильтров. На бэке оба обрабатываются: single через `scopeInCategory()`, multi через `whereIn` + `include_descendants`. При наличии обоих действуют как AND.

---

## 3. Фильтрация — виды фильтров

10. **Поиск (q)** — `scopeSearch()`: `LOWER() + LIKE` для `name`/`description`/`sku`, точное совпадение (`=`) для `barcode` (EAN/UPC). Поля через `orWhere`.

11. **Категории** — множественный (`category_ids[]`), с `include_descendants`.

12. **Бренды** — множественный (`brand_ids[]`).

13. **Коллекции** — множественный (`collection_ids[]`).

14. **Цена** — `price_min`/`price_max` + ценовые buckets (интервалы с количеством товаров).

15. **Наличие (in_stock)** — три режима (`in_stock_mode`): `instock`, `preorder`, `notavailable`. `scopeInStock()` строит подзапрос к `warehouse_product` с поддержкой `warehouse_id` и `region_id`.

16. **Скидка (in_sale)** — три состояния: `1` (только со скидкой), `0` (без), пусто (все).

17. **Избранное (in_favourites)** — по `user_id` или `guest_token`.

18. **Корзина (in_cart)** — два режима: «в корзине» / «не в корзине».

19. **Просмотренные (viewed)** — два режима: просмотренные / не просмотренные. По `user_id` или `guest_token`.

20. **Медиа (with_images / with_video)** — чекбоксы.

21. **Характеристики (features)** — динамические фасетные блоки с чекбоксами по значениям `FeatureValue`.

---

## 4. Особенности фильтров

22. **Фасетные счётчики** — каждое значение показывает count товаров. Нулевые скрываются (кроме уже выбранных).

23. **AND / OR** — по умолчанию AND для характеристик. `feature_any=1` переключает в OR.

24. **Поиск внутри фильтра** — при ≥10 значений. Выбранные всегда видны.

25. **Кнопка очистки у каждого блока** — сбрасывает один фильтр.

26. **Compact URL** — `fv`, `b`, `s`, `v`, `pp`, `p`, `c`, `cl` вместо полных имён. Дефолтные значения опускаются.

27. **Серверные алиасы** — `ProductFilterRequest::prepareForValidation()` разворачивает compact-параметры (`fv=10,11` → `feature_value_ids[]`).

28. **Сброс page=1** при смене любого фильтра.

---

## 5. Отображение: Grid / List

29. **Два режима** — `grid` и `list`, параметр `view` в URL.

30. **Grid** — `grid-cols-2 → md:2 → lg:3 → xl:5`. Настраиваемый `gridCols` (4/5/6).

31. **List** — вертикальный стек. Разные item-компоненты: `ProductGridItem` / `ProductListItem`.

32. **Skeleton loading** — 12 карточек-скелетонов в соответствующем виде.

33. **Empty state** — `NotFound` с иконкой и подсказкой.

---

## 6. Сортировка

34. **6 режимов** — Newest, PriceAsc, PriceDesc, NameAsc, NameDesc, Popularity.

35. **Стабильная сортировка** — вторичный ключ `id DESC` для стабильности.

36. **Пользовательские цены** — если join с `user_product_prices`, сортировка по `final_price`.

37. **CatalogSort — PHP Enum** с `apply(Builder)` и `$query->reorder()`.

---

## 7. Пагинация

38. **Классическая** — `UnifiedPagination`: номера страниц (≤5 видимых), «Пред» / «След», многоточия.

39. **Информация** — «Показано X–Y из Z товаров».

40. **Infinite scroll** — чекбокс. При включении: пагинация скрывается, автозагрузка при 80% скролла.

41. **Дедупликация** — `Set<id>` на клиенте при дозагрузке.

42. **per_page** — 10 / 20 / 40 / 60 / 100.

43. **Скрытие** — если 1 страница, пагинация скрыта полностью.

---

## 8. Выбранные фильтры (SelectedFilters)

44. **Chips** — каждый активный фильтр = бейдж с × . Человекочитаемые подписи (имя бренда вместо ID, «Характеристика: Значение»).

45. **«Сбросить всё»** — сбрасывает фильтры (не сортировку и вид).

46. **«★ Сохранить фильтр»** — появляется если есть фильтры и текущий набор не сохранён.

47. **Сохранённые** — бейджи со звёздочкой. Клик открывает, × удаляет. Активный подсвечен.

---

## 9. Сохранение фильтров

48. **Диалог** — модалка с полем имени.

49. **Сохраняется полный path** — `pathname + search`.

50. **Гибрид** — авторизованные: `SavedCollection` на сервере (POST/DELETE `/collections`). Гости: `localStorage`.

51. **Merge** — при загрузке `localStorage` и server данные мержатся (server wins).

52. **Открытие** — `router.visit(path, { replace: true })`.

---

## 10. SSR + CSR гибрид

53. **Shell на сервере** — Inertia рендерит страницу с props: `initialBrand`, `initialCategory`, `savedCollections`, `seo`. SEO-friendly для роботов.

54. **Данные через API** — товары, фасеты, ценовые интервалы загружаются через `/api/products`, `/api/products/facets`, `/api/products/price-intervals`. Три раздельных запроса параллельно.

55. **SeoHead** — `seo` prop → meta tags (title, description, og:). Уникальный title для каждого контекста.

56. **Чистые URL** — human-readable slugs (`/brands/lelo`).

---

## 11. Мобильная версия

57. **Фильтры в Sheet** — на мобильных фильтры в выдвижной панели. Desktop (≥lg) — sidebar 224px.

58. **Горизонтальный скролл контролов** — панель «Фильтры, Вид, Показывать, Сортировка» скроллится на мобильных.

59. **Адаптивная сетка** — `grid-cols-2` → `md:2` → `lg:3` → `xl:5`.

60. **Минимальные отступы** — `px-2` mobile, `sm:px-6` desktop.

---

## 12. Безопасность

61. **Policy** — `SavedCollectionPolicy` — только свои фильтры.

62. **Guest-токен** — `App\Support\Guest::token($request)` для избранного/корзины/просмотренных гостей.

63. **Валидация** — `ProductFilterRequest`: `exists` для ID, `enum` для sort, `in:` для per_page.

---

## 13. Оптимизации — Best Practices (улучшения относительно референса)

> [!IMPORTANT]
> Ниже описаны архитектурные решения, **отличающиеся от референса** и устраняющие все выявленные ограничения.

### 13.1 — AbortController для всех fetch-запросов

64. **AbortController** — каждый цикл `fetchProducts` / `fetchFacets` / `fetchPriceIntervals` создаёт `AbortController`, передаёт `signal` в `fetch()`, и отменяет предыдущий через cleanup в `useEffect`. Это **полностью устраняет race conditions** — поздний ответ никогда не перезапишет свежий.

```jsx
useEffect(() => {
    const controller = new AbortController();
    fetchProducts({ signal: controller.signal });
    fetchFacets({ signal: controller.signal });
    fetchPriceIntervals({ signal: controller.signal });
    return () => controller.abort();
}, [paramsString]);
```

### 13.2 — Cursor-пагинация для infinite scroll

65. **Cursor-based pagination** — при infinite scroll вместо offset-paginate используется `cursorPaginate()` Laravel. Это гарантирует стабильную выборку: вставка/удаление товаров между запросами страниц **не вызывает** дубли или пропуски.

66. **Классическая пагинация** — остаётся offset-based (`paginate()`) — она нужна для отображения номеров страниц и «перейти на страницу N».

67. **Автовыбор** — при включении infinite scroll бэкенд переключается на `cursorPaginate()`, при выключении — возвращается к `paginate()`.

### 13.3 — Серверное кэширование фасетов

68. **Cache-слой для фасетов** — `Cache::remember("facets:{$cacheKey}", 60, fn() => ...)`. Ключ формируется из нормализованных фильтров (без page/sort/view). TTL 60 секунд.

69. **Инвалидация** — при создании/обновлении/удалении товара очищается кэш фасетов через `Cache::tags(['facets'])->flush()` в Observer.

70. **Ценовые интервалы** — аналогичное кэширование: `Cache::remember("price_intervals:{$key}", 60, ...)`.

71. **Каталог товаров** — НЕ кэшируется (данные персонализированы: цены, скидки, наличие зависят от пользователя и региона).

### 13.4 — Оптимизация фасетов: единый запрос

72. **Единый SQL для фасетов** — вместо N подзапросов (по одному на каждую характеристику), используется один запрос с `GROUP BY feature_id, feature_value_id` и агрегацией. Это сокращает N+1 до одного SQL.

```sql
SELECT fv.feature_id, fv.id as value_id, fv.value, COUNT(DISTINCT pfv.product_id) as count
FROM feature_values fv
JOIN product_feature_value pfv ON pfv.feature_value_id = fv.id
WHERE pfv.product_id IN (... filtered products subquery ...)
GROUP BY fv.feature_id, fv.id, fv.value
ORDER BY fv.feature_id, count DESC
```

73. **Бренды и категории** — аналогично, один запрос с `GROUP BY` вместо отдельных запросов.

### 13.5 — Ленивая загрузка справочников

74. **Виртуализация списков фильтров** — вместо загрузки всех 999 брендов единым бэкенд-запросом, используется поиск с серверной фильтрацией и пагинацией. Компонент фильтра запрашивает `/api/brands?q=...&per_page=20` при вводе.

75. **Начальная загрузка** — при монтировании загружаются только топ-20 популярных + те, которые уже выбраны в фильтрах.

76. **Кэширование на клиенте** — загруженные элементы хранятся в `Map` и не запрашиваются повторно.

### 13.6 — Debounce для поиска и цены

77. **Debounce поиска** — изменение поля `q` не вызывает немедленный запрос. Используется `useDebounce(300ms)` — запрос уходит через 300ms после окончания набора.

78. **Debounce цены** — аналогично для `price_min`/`price_max`: запрос через 500ms после остановки ввода.

79. **Остальные фильтры** — без debounce (чекбоксы, селекты — мгновенная реакция).

### 13.7 — Оптимистичный UI

80. **Оптимистичные чипсы** — при нажатии на фильтр чипс добавляется мгновенно (не дожидаясь ответа API). Skeleton показывается только для сетки товаров.

81. **Skeleton только для контента** — панель фильтров, выбранные фильтры, сортировка, пагинация остаются visible и interactive во время загрузки.

### 13.8 — Предзагрузка и SWR

82. **stale-while-revalidate** — при навигации назад в каталог показываются предыдущие результаты из кэша (stale), а в фоне запрашиваются свежие данные (revalidate). Это убирает пустой экран при возврате.

83. **Prefetch** — при наведении на кнопку пагинации `onMouseEnter` начинает загрузку следующей страницы. При клике данные уже в кэше.

### 13.9 — Structured Data для SEO

84. **JSON-LD** — на каждой странице каталога генерируется `<script type="application/ld+json">` с `ItemList` schema. Для страниц бренда — `Brand` schema. Для категории — `CollectionPage`.

85. **Canonical URL** — `<link rel="canonical">` указывает на URL без page/sort/view параметров (только фильтры). Предотвращает дублирование в индексе поисковиков.

86. **Robots meta** — страницы с фильтрами, содержащие `price_min`, `price_max`, `feature_value_ids`, получают `noindex, follow` чтобы не засорять индекс.

### 13.10 — Accessibility

87. **ARIA-labels** — все интерактивные элементы фильтров имеют `aria-label`. SelectedFilters chips содержат `aria-label="Убрать фильтр: Бренд: Lelo"`.

88. **Keyboard navigation** — фильтры управляемы с клавиатуры: Tab для навигации, Space/Enter для активации, Escape для закрытия Sheet.

89. **Live regions** — при загрузке товаров `aria-live="polite"` на счётчике товаров анонсирует новое количество.

90. **Focus management** — при закрытии Sheet фокус возвращается на кнопку «Фильтры».

### 13.11 — Тестирование

91. **Feature tests** — `ProductCatalogFeatureTest`: фильтрация по category/brand/collection/features/price/stock, сортировка, пагинация. Проверка что фасетные счётчики корректны.

92. **Compact URL tests** — round-trip: `buildCompactQuery(parse(build(filters)))` === `build(filters)`.

93. **Browser tests** — Playwright/Cypress: мобильный Sheet, infinite scroll, сохранение фильтров, skeleton loading, переключение grid/list.

---

## Итого

| Аспект | Референс | Best Practices |
|--------|----------|----------------|
| Race conditions | Нет AbortController | AbortController для всех fetch |
| Infinite scroll | Offset + клиентский dedup | Cursor-paginate на бэке |
| Кэширование | Нет | Cache::remember для фасетов/цен |
| Фасеты N+1 | N запросов на N характеристик | Один GROUP BY запрос |
| Справочники | per_page=999 разом | Серверный поиск + top-20 |
| Поиск/цена | Мгновенный запрос | Debounce 300–500ms |
| SEO | SeoHead (title/meta) | + JSON-LD + canonical + noindex для фильтров |
| a11y | Минимально | ARIA + keyboard + live regions |
| Тестирование | Feature tests | + browser tests + compact URL round-trip |

> **93 пункта** в 13 разделах. Разделы 1–12 описывают сохранённый функционал, раздел 13 — улучшения по best practices.

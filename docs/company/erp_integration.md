# Интеграция компаний с ERP через RabbitMQ

Этот документ описывает протокол взаимодействия для синхронизации данных компаний между сайтом (Pecado) и ERP-системой.

## 1. Исходящие сообщения (Сайт -> ERP)

Сайт публикует события о создании, обновлении и удалении компаний в очередь `erp_events`.

**Очередь:** `erp_events`  
**Формат:** JSON

---

### События

| Событие | Описание |
|---------|----------|
| `CompanyCreated` | Пользователь создал новую компанию |
| `CompanyUpdated` | Данные компании были изменены |
| `CompanyDeleted` | Компания была удалена (soft delete) |

---

### Структура сообщения

```json
{
  "event": "CompanyCreated",
  "timestamp": "2026-01-29T12:00:00+03:00",
  "company": {
    "id": 1,
    "user_id": 5,
    "country": "RU",
    "name": "Тест Компания",
    "legal_name": "ООО \"Тест Компания\"",
    "tax_id": "1234567890",
    "registration_number": "1234567890123",
    "tax_code": "123456789",
    "okpo_code": "12345678",
    "legal_address": "г. Москва, ул. Тестовая, д. 1",
    "actual_address": "г. Москва, ул. Фактическая, д. 2",
    "phone": "+7 (999) 123-45-67",
    "email": "company@example.com",
    "erp_id": null,
    "created_at": "2026-01-29T12:00:00.000000Z",
    "updated_at": "2026-01-29T12:00:00.000000Z",
    "deleted_at": null,
    "bank_accounts": [
      {
        "id": 1,
        "company_id": 1,
        "bank_name": "Сбербанк",
        "bank_bik": "044525225",
        "correspondent_account": "30101810400000000225",
        "account_number": "40702810938000012345",
        "is_primary": true,
        "created_at": "2026-01-29T12:00:00.000000Z",
        "updated_at": "2026-01-29T12:00:00.000000Z"
      }
    ]
  },
  "user": {
    "id": 5,
    "erp_id": "user-uuid-1234-5678"
  }
}
```

---

### Описание полей компании

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | int | ID компании на сайте |
| `user_id` | int | ID владельца компании |
| `country` | enum | Код страны: `RU`, `BY`, `KZ` |
| `name` | string | Краткое название компании |
| `legal_name` | string | Юридическое наименование |
| `tax_id` | string | ИНН (RU) / УНП (BY) / БИН (KZ) |
| `registration_number` | string? | ОГРН/ОГРНИП (только RU) |
| `tax_code` | string? | КПП (только RU) |
| `okpo_code` | string? | ОКПО (RU/BY) |
| `legal_address` | string | Юридический адрес |
| `actual_address` | string? | Фактический адрес |
| `phone` | string? | Телефон |
| `email` | string? | Email |
| `erp_id` | string? | ID компании в ERP (null при создании) |
| `deleted_at` | datetime? | Дата удаления (soft delete) |
| `bank_accounts` | array | Массив банковских реквизитов |

### Описание полей банковского счёта

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | int | ID банковского счёта |
| `bank_name` | string | Название банка |
| `bank_bik` | string | БИК банка |
| `correspondent_account` | string | Корреспондентский счёт |
| `account_number` | string | Номер расчётного счёта |
| `is_primary` | bool | Основной счёт компании |

### Описание user

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | int | ID пользователя на сайте |
| `erp_id` | string? | ID пользователя в ERP |

---

## 2. Входящие сообщения (ERP -> Сайт)

ERP-система должна отправить `erp_id` после обработки компании.

**Очередь:** `erp_incoming`  
**Формат:** Raw JSON

### Ожидаемая структура

```json
{
  "company": {
    "id": 1
  },
  "erp_id": "company-uuid-1234-5678"
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `company.id` | int | ID компании на сайте (обязательное) |
| `erp_id` | string | ID компании в ERP (обязательное) |

---

## 3. Страновая специфика

### Россия (RU)
- `tax_id`: ИНН (10 или 12 цифр)
- `registration_number`: ОГРН (13 или 15 цифр)
- `tax_code`: КПП (9 цифр)
- `okpo_code`: ОКПО (8 цифр)

### Беларусь (BY)
- `tax_id`: УНП (9 цифр)
- `okpo_code`: ОКПО (8 цифр)
- `registration_number`: не используется
- `tax_code`: не используется

### Казахстан (KZ)
- `tax_id`: БИН/ИИН (12 цифр)
- Остальные поля: не используются

---

## Контакты

По техническим вопросам интеграции обращаться к команде разработки.

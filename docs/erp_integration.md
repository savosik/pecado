# Интеграция с ERP через RabbitMQ

Этот документ описывает протокол взаимодействия между сайтом (Pecado) и ERP-системой посредством очередей сообщений RabbitMQ.

## 1. Исходящие сообщения (Сайт -> ERP)

Сайт публикует события о создании и обновлении пользователей в очередь `erp_events`.

**Очередь:** `erp_events`
**Формат:** JSON

### Структура сообщения

Сообщение содержит тип события, временную метку и полные данные пользователя.

```json
{
  "event": "UserCreated", // или "UserUpdated"
  "timestamp": "2024-01-29T12:00:00+03:00",
  "user": {
    "id": 1,
    "name": "Иван Иванов",
    "email": "ivan@example.com",
    "phone": "+79990000000",
    "surname": "Иванов",
    "patronymic": "Иванович",
    "country": "Россия",
    "city": "Москва",
    "status": "processing",
    "is_admin": false,
    "erp_id": null,
    // ... другие поля пользователя
    "created_at": "...",
    "updated_at": "..."
  }
}
```

### События

*   `UserCreated`: Отправляется при регистрации нового пользователя.
*   `UserUpdated`: Отправляется при изменении профиля пользователя.

---

## 2. Входящие сообщения (ERP -> Сайт)

ERP-система должна отправлять уведомления на сайт после обработки пользователя (например, присвоения `erp_id` или изменения статуса).

**Очередь:** `erp_incoming`
**Формат:** Raw JSON

Сайт использует специальный консьюмер (`php artisan erp:consume`), который прослушивает эту очередь и обрабатывает JSON-сообщения.

### Ожидаемая структура данных (Payload)

```json
{
  "user": {
    "id": 1
  },
  "erp_id": "uuid-1234-5678",
  "status": "confirmed"
}
```

*   `user.id`: Идентификатор пользователя на сайте (int, обязательное).
*   `erp_id`: Уникальный идентификатор пользователя в ERP (string, обязательное).
*   `status`: Новый статус пользователя (string, опционально).

### Логика обработки

1. Консьюмер получает JSON из очереди `erp_incoming`.
2. Валидирует JSON.
3. Запускает Job `ProcessErpUserUpdate`, который обновляет данные пользователя в БД.

---

## Контакты

По техническим вопросам интеграции обращаться к команде разработки.
